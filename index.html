<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Parking Hero - Login</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; background: #222; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100vh; }
        
        /* UI CONTROLS */
        .top-left { position: absolute; top: 20px; left: 20px; z-index: 20; display: flex; flex-direction: column; gap: 10px; }
        
        .score-board {
            background: white; padding: 10px 15px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-weight: bold;
            display: flex; align-items: center; gap: 10px; min-width: 120px;
        }
        
        .heatmap-toggle {
            background: #2c3e50; color: white; border: none; padding: 10px 15px;
            border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px;
        }

        /* LOGIN BUTTON STYLES */
        .login-btn {
            background: #4285F4; color: white; border: none; padding: 10px 15px;
            border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;
        }
        .user-pic { width: 30px; height: 30px; border-radius: 50%; display: none; border: 2px solid white; }

        .status-panel {
            position: absolute; top: 20px; right: 20px; z-index: 20;
            background: rgba(0,0,0,0.8); color: white; padding: 10px; 
            border-radius: 12px; font-size: 12px; width: 110px; text-align: center;
        }
        .speed-text { font-size: 24px; font-weight: bold; color: #2ecc71; }

        .ui-overlay { 
            position: absolute; bottom: 40px; width: 100%; 
            display: flex; justify-content: center; z-index: 10; pointer-events: none;
        }
        #leaving-btn { 
            pointer-events: auto;
            background-color: #2ecc71; color: white; border: none; padding: 18px 35px; 
            border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); transition: transform 0.2s;
        }
        .reserve-btn {
            background: #f39c12; color: white; border: none; padding: 8px 12px;
            border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; width: 100%;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="top-left">
    <div class="score-board">
        <button id="login-btn" class="login-btn">ðŸ”µ Sign In</button>
        <img id="user-pic" class="user-pic" src="" alt="User">
        <span id="user-score" style="display:none;">0 Pts</span>
    </div>
    
    <button id="heatmap-btn" class="heatmap-toggle">ðŸ”¥ Heatmap: OFF</button>
</div>

<div class="status-panel">
    <div>DETECTING</div>
    <div id="speed-display" class="speed-text">0 km/h</div>
    <div id="activity-status" style="color: #aaa;">Wait...</div>
</div>

<div class="ui-overlay">
    <button id="leaving-btn">ðŸš€ I'M LEAVING MY SPOT</button>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyB8kFY4GeObcxFMBCc02JIVbGnmuLxoi30",
        authDomain: "parking-hero-35c61.firebaseapp.com",
        databaseURL: "https://parking-hero-35c61-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "parking-hero-35c61",
        storageBucket: "parking-hero-35c61.firebasestorage.app",
        messagingSenderId: "772752240494",
        appId: "1:772752240494:web:2313bc6b8dd836422cdb7f"
    };

    try { firebase.initializeApp(firebaseConfig); var database = firebase.database(); var auth = firebase.auth(); } catch(e) {}

    // GLOBAL VARIABLES
    let currentUser = null;
    let userPoints = 0;

    // --- 2. AUTHENTICATION LOGIC ---
    const loginBtn = document.getElementById('login-btn');
    const userPic = document.getElementById('user-pic');
    const scoreDisplay = document.getElementById('user-score');

    // Check if user is already logged in
    auth.onAuthStateChanged((user) => {
        if (user) {
            // LOGGED IN
            currentUser = user;
            loginBtn.style.display = 'none';
            userPic.src = user.photoURL;
            userPic.style.display = 'block';
            scoreDisplay.style.display = 'block';
            
            // Load Points from Database (NOT LocalStorage)
            database.ref('users/' + user.uid + '/points').on('value', (snapshot) => {
                userPoints = snapshot.val() || 0;
                scoreDisplay.innerText = userPoints + " Pts";
            });

        } else {
            // GUEST MODE
            currentUser = null;
            loginBtn.style.display = 'block';
            userPic.style.display = 'none';
            scoreDisplay.style.display = 'none';
        }
    });

    // Login Action
    loginBtn.onclick = () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch((error) => {
            alert("Login Failed: " + error.message);
        });
    };

    // --- 3. MAP SETUP ---
    mapboxgl.accessToken = 'pk.eyJ1IjoidmlzaDI5MDAiLCJhIjoiY21rNm9yaGw3MHNoZjNmcXhlN2RoNGNjayJ9.iUX7FE03cK6jS7Ohft-zqQ';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11', 
        center: [77.6608, 12.8320], zoom: 16
    });

    const geolocate = new mapboxgl.GeolocateControl({ positionOptions: { enableHighAccuracy: true }, trackUserLocation: true, showUserHeading: true });
    map.addControl(geolocate);

    map.on('load', () => {
        geolocate.trigger();

        // HEATMAP LAYER
        map.addSource('history-data', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
        map.addLayer({
            id: 'parking-heatmap', type: 'heatmap', source: 'history-data', maxzoom: 19,
            layout: { 'visibility': 'none' },
            paint: {
                'heatmap-weight': 1,
                'heatmap-color': ['interpolate', ['linear'], ['heatmap-density'], 0, 'rgba(33,102,172,0)', 0.2, 'rgb(103,169,207)', 0.4, 'rgb(209,229,240)', 0.6, 'rgb(253,219,199)', 0.8, 'rgb(239,138,98)', 1, 'rgb(178,24,43)'],
                'heatmap-intensity': 1, 'heatmap-radius': 30, 'heatmap-opacity': 0.8
            }
        });
    });

    // --- 4. DATA LOGIC ---
    
    // Load Heatmap Data
    database.ref('history').on('value', (snapshot) => {
        const data = snapshot.val();
        if(data) {
            const features = Object.values(data).map(pt => ({ type: 'Feature', geometry: { type: 'Point', coordinates: [pt.lng, pt.lat] } }));
            if(map.getSource('history-data')) map.getSource('history-data').setData({ type: 'FeatureCollection', features: features });
        }
    });

    // Toggle Heatmap
    let isHeatmapOn = false;
    document.getElementById('heatmap-btn').onclick = function() {
        isHeatmapOn = !isHeatmapOn;
        const btn = document.getElementById('heatmap-btn');
        if (isHeatmapOn) {
            map.setLayoutProperty('parking-heatmap', 'visibility', 'visible');
            btn.innerHTML = "ðŸ”¥ Heatmap: ON"; btn.style.background = "#e74c3c";
        } else {
            map.setLayoutProperty('parking-heatmap', 'visibility', 'none');
            btn.innerHTML = "ðŸ”¥ Heatmap: OFF"; btn.style.background = "#2c3e50";
        }
    };

    // Reservation Logic
    window.reserveSpot = function(spotId) {
        if (!currentUser) { alert("Please Sign In to Reserve!"); return; }
        if (userPoints < 20) { alert("âŒ Need 20 Points!"); return; }

        database.ref('spots/' + spotId).update({ status: 'reserved', reservedBy: currentUser.uid }).then(() => {
            // Deduct Points in Database
            database.ref('users/' + currentUser.uid + '/points').set(userPoints - 20);
            alert("âœ… Spot Reserved!");
        });
    };

    // Show Spots
    database.ref('spots').on('value', (snapshot) => {
        const spots = snapshot.val();
        if(spots) {
            const now = Date.now();
            Object.values(spots).forEach(spot => {
                if (now - spot.timestamp < 1800000) { 
                    let shouldShow = true;
                    let icon = 'ðŸš—';
                    let popup = `<b>Free Spot!</b><br>${spot.time}<br><button class="reserve-btn" onclick="reserveSpot(${spot.timestamp})">Reserve (20 Pts)</button>`;
                    
                    if (spot.status === 'reserved') {
                        // Check if currentUser exists before checking UID
                        if (currentUser && spot.reservedBy === currentUser.uid) { icon = 'ðŸŸ§'; popup = `<b>ðŸ”’ RESERVED</b>`; }
                        else { shouldShow = false; }
                    }
                    if (shouldShow) {
                        const el = document.createElement('div');
                        el.innerHTML = icon; el.style.fontSize = '30px';
                        new mapboxgl.Marker(el).setLngLat([spot.lng, spot.lat]).setPopup(new mapboxgl.Popup().setHTML(popup)).addTo(map);
                    }
                }
            });
        }
    });

    // Report Button
    document.getElementById('leaving-btn').onclick = function() {
        const btn = document.getElementById('leaving-btn');
        if (!currentUser) { alert("Please Sign In to earn points!"); return; } // Require Login
        
        btn.innerText = "Locating...";
        navigator.geolocation.getCurrentPosition((pos) => {
            const id = Date.now();
            const pt = { lat: pos.coords.latitude, lng: pos.coords.longitude, timestamp: id };
            
            database.ref('spots/' + id).set({ ...pt, time: new Date().toLocaleTimeString(), status: 'free' });
            database.ref('history/' + id).set(pt);

            // SAVE POINTS TO DATABASE (Not LocalStorage)
            database.ref('users/' + currentUser.uid + '/points').set(userPoints + 10);
            
            map.flyTo({ center: [pt.lng, pt.lat], zoom: 17 });
            btn.innerText = "âœ… +10 POINTS!";
            setTimeout(() => { btn.innerText = "ðŸš€ I'M LEAVING MY SPOT"; }, 3000);
        });
    };

    // Movement Tracker
    navigator.geolocation.watchPosition((pos) => {
        const speed = pos.coords.speed; 
        let kmh = speed ? (speed * 3.6).toFixed(1) : 0;
        document.getElementById('speed-display').innerText = kmh + " km/h";
        const statusEl = document.getElementById('activity-status');
        if (kmh < 2) { statusEl.innerText = "ðŸ›‘ Standing"; statusEl.style.color = "#aaa"; }
        else if (kmh < 15) { statusEl.innerText = "ðŸš¶ Walking"; statusEl.style.color = "#f1c40f"; }
        else { statusEl.innerText = "ðŸš— Driving"; statusEl.style.color = "#2ecc71"; }
    }, (e)=>console.log(e), {enableHighAccuracy:true});

</script>
</body>
</html>
