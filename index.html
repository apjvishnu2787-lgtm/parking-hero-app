<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Parking Hero - Heatmap Data</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100vh; background: #ddd; }
        
        /* UI CONTROLS */
        .top-left { position: absolute; top: 20px; left: 20px; z-index: 20; display: flex; flex-direction: column; gap: 10px; }
        
        .score-board {
            background: white; padding: 10px 15px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); font-weight: bold;
            display: flex; align-items: center; gap: 10px;
        }
        
        .heatmap-toggle {
            background: #2c3e50; color: white; border: none; padding: 10px 15px;
            border-radius: 50px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 5px;
        }

        .status-panel {
            position: absolute; top: 20px; right: 20px; z-index: 20;
            background: rgba(0,0,0,0.8); color: white; padding: 10px; 
            border-radius: 12px; font-size: 12px; width: 110px; text-align: center;
        }
        .speed-text { font-size: 24px; font-weight: bold; color: #2ecc71; }

        .ui-overlay { 
            position: absolute; bottom: 40px; width: 100%; 
            display: flex; justify-content: center; z-index: 10; pointer-events: none;
        }
        #leaving-btn { 
            pointer-events: auto;
            background-color: #2ecc71; color: white; border: none; padding: 18px 35px; 
            border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); transition: transform 0.2s;
        }
        .reserve-btn {
            background: #f39c12; color: white; border: none; padding: 8px 12px;
            border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; width: 100%;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="top-left">
    <div class="score-board">
        <span>üèÜ</span>
        <span id="user-score">0 Points</span>
    </div>
    <button id="heatmap-btn" class="heatmap-toggle">üî• Heatmap: OFF</button>
</div>

<div class="status-panel">
    <div>DETECTING</div>
    <div id="speed-display" class="speed-text">0 km/h</div>
    <div id="activity-status" style="color: #aaa;">Wait...</div>
</div>

<div class="ui-overlay">
    <button id="leaving-btn">üöÄ I'M LEAVING MY SPOT</button>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyB8kFY4GeObcxFMBCc02JIVbGnmuLxoi30",
        authDomain: "parking-hero-35c61.firebaseapp.com",
        databaseURL: "https://parking-hero-35c61-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "parking-hero-35c61",
        storageBucket: "parking-hero-35c61.firebasestorage.app",
        messagingSenderId: "772752240494",
        appId: "1:772752240494:web:2313bc6b8dd836422cdb7f"
    };

    try { firebase.initializeApp(firebaseConfig); var database = firebase.database(); } catch(e) {}

    let myUserId = localStorage.getItem('heroUserId');
    if (!myUserId) { myUserId = 'user_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('heroUserId', myUserId); }

    // --- 2. MAP SETUP ---
    mapboxgl.accessToken = 'pk.eyJ1IjoidmlzaDI5MDAiLCJhIjoiY21rNm9yaGw3MHNoZjNmcXhlN2RoNGNjayJ9.iUX7FE03cK6jS7Ohft-zqQ';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11', // CHANGED TO DARK MODE (Looks better for heatmaps!)
        center: [77.6608, 12.8320], zoom: 16
    });

    const geolocate = new mapboxgl.GeolocateControl({ positionOptions: { enableHighAccuracy: true }, trackUserLocation: true, showUserHeading: true });
    map.addControl(geolocate);

    map.on('load', () => {
        geolocate.trigger();

        // -- SETUP HEATMAP LAYER --
        map.addSource('history-data', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: [] }
        });

        map.addLayer({
            id: 'parking-heatmap',
            type: 'heatmap',
            source: 'history-data',
            maxzoom: 19,
            layout: { 'visibility': 'none' }, // Hidden by default
            paint: {
                // Increase the heatmap weight based on frequency
                'heatmap-weight': 1,
                // Color ramp for heatmap.  Domain is 0 (low) to 1 (high).
                'heatmap-color': [
                    'interpolate', ['linear'], ['heatmap-density'],
                    0, 'rgba(33,102,172,0)',
                    0.2, 'rgb(103,169,207)',
                    0.4, 'rgb(209,229,240)',
                    0.6, 'rgb(253,219,199)',
                    0.8, 'rgb(239,138,98)',
                    1, 'rgb(178,24,43)'
                ],
                'heatmap-intensity': 1,
                'heatmap-radius': 30,
                'heatmap-opacity': 0.8
            }
        });
    });

    // --- 3. LOGIC: LOAD HISTORY FOR HEATMAP ---
    database.ref('history').on('value', (snapshot) => {
        const data = snapshot.val();
        if(data) {
            const features = Object.values(data).map(pt => ({
                type: 'Feature',
                geometry: { type: 'Point', coordinates: [pt.lng, pt.lat] }
            }));
            
            if(map.getSource('history-data')) {
                map.getSource('history-data').setData({ type: 'FeatureCollection', features: features });
            }
        }
    });

    // --- 4. TOGGLE BUTTON LOGIC ---
    let isHeatmapOn = false;
    document.getElementById('heatmap-btn').onclick = function() {
        isHeatmapOn = !isHeatmapOn;
        const btn = document.getElementById('heatmap-btn');
        
        if (isHeatmapOn) {
            map.setLayoutProperty('parking-heatmap', 'visibility', 'visible');
            btn.innerHTML = "üî• Heatmap: ON";
            btn.style.background = "#e74c3c"; // Red
        } else {
            map.setLayoutProperty('parking-heatmap', 'visibility', 'none');
            btn.innerHTML = "üî• Heatmap: OFF";
            btn.style.background = "#2c3e50"; // Dark Blue
        }
    };

    // --- 5. ECONOMY & LIVE SPOTS (Previous Logic) ---
    let userPoints = parseInt(localStorage.getItem('heroPoints') || 50);
    document.getElementById('user-score').innerText = userPoints + " Points";

    window.reserveSpot = function(spotId) {
        if (userPoints < 20) { alert("‚ùå Need 20 Points!"); return; }
        database.ref('spots/' + spotId).update({ status: 'reserved', reservedBy: myUserId }).then(() => {
            userPoints -= 20; localStorage.setItem('heroPoints', userPoints);
            document.getElementById('user-score').innerText = userPoints + " Points";
            alert("‚úÖ Spot Reserved!");
        });
    };

    database.ref('spots').on('value', (snapshot) => {
        const spots = snapshot.val();
        // Note: For simplicity, we keep adding markers. In production, we'd clear old ones.
        if(spots) {
            const now = Date.now();
            Object.values(spots).forEach(spot => {
                if (now - spot.timestamp < 1800000) { 
                    let shouldShow = true;
                    let icon = 'üöó';
                    let popup = `<b>Free Spot!</b><br>${spot.time}<br><button class="reserve-btn" onclick="reserveSpot(${spot.timestamp})">Reserve (20 Pts)</button>`;
                    
                    if (spot.status === 'reserved') {
                        if (spot.reservedBy === myUserId) { icon = 'üüß'; popup = `<b>üîí RESERVED</b>`; }
                        else { shouldShow = false; }
                    }
                    if (shouldShow) {
                        const el = document.createElement('div');
                        el.innerHTML = icon; el.style.fontSize = '30px';
                        new mapboxgl.Marker(el).setLngLat([spot.lng, spot.lat]).setPopup(new mapboxgl.Popup().setHTML(popup)).addTo(map);
                    }
                }
            });
        }
    });

    // Report Button
    document.getElementById('leaving-btn').onclick = function() {
        const btn = document.getElementById('leaving-btn');
        btn.innerText = "Locating...";
        navigator.geolocation.getCurrentPosition((pos) => {
            const id = Date.now();
            const pt = { lat: pos.coords.latitude, lng: pos.coords.longitude, timestamp: id };
            
            // Save Live & History
            database.ref('spots/' + id).set({ ...pt, time: new Date().toLocaleTimeString(), status: 'free' });
            database.ref('history/' + id).set(pt);

            // Points
            userPoints += 10; localStorage.setItem('heroPoints', userPoints);
            document.getElementById('user-score').innerText = userPoints + " Points";
            
            map.flyTo({ center: [pt.lng, pt.lat], zoom: 17 });
            btn.innerText = "‚úÖ +10 POINTS!";
            setTimeout(() => { btn.innerText = "üöÄ I'M LEAVING MY SPOT"; }, 3000);
        });
    };

    // Movement
    navigator.geolocation.watchPosition((pos) => {
        const speed = pos.coords.speed; 
        let kmh = speed ? (speed * 3.6).toFixed(1) : 0;
        document.getElementById('speed-display').innerText = kmh + " km/h";
        const statusEl = document.getElementById('activity-status');
        if (kmh < 2) { statusEl.innerText = "üõë Standing"; statusEl.style.color = "#aaa"; }
        else if (kmh < 15) { statusEl.innerText = "üö∂ Walking"; statusEl.style.color = "#f1c40f"; }
        else { statusEl.innerText = "üöó Driving"; statusEl.style.color = "#2ecc71"; }
    }, (e)=>console.log(e), {enableHighAccuracy:true});

</script>
</body>
</html>
